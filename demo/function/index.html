<script type="module">
  import {
    prompt,
    ChromePromptConfiguration,
  } from "@paulkinlan/reactive-prompt/chrome";
  import { isSignal } from "@paulkinlan/reactive-prompt"
  import { signal, computed, effect } from "@preact/signals-core";

  function accumulate(strings, values) {
    const returnSignal = signal();
    effect(() => {
      const result = [strings[0]];
      for (let valueIdx = 0; valueIdx < values.length; valueIdx++) {
        let value = values[valueIdx];
        if (isSignal(value)) {
          // This dereference sets up the notification dependency
          value = value.value;
        }
        // TODO: if value is a promise we need to work out how to resolve it as we add it.
        result.push(value, strings[valueIdx + 1]);
      }

      returnSignal.value = result.join("");
    });

    return returnSignal;
  }

  const f = (strings, ...values) => {
    const promptSignal = accumulate(
      strings,
      values);
    const returnSignal = signal();
    const genFunc = signal();

    const parseJS = (js) => {
      const codeExtractRegExp = /```JavaScript(.*?)```/ims;
      const results = codeExtractRegExp.exec(js);
      if (results && results.length > 0) {
        return results[1].replace(/^\nfunction/, "function");
      }

      return;
    }

    effect(() => {
      genFunc.value = prompt`You are an advanced software engineer. Generate a valid function using only valid JavaScript that will solve the following problem: ${promptSignal}. 
      
You MUST follow these rules:
+ Your target platform is the Web Browser.
+ You can use any browser APIs.
+ You MUST never try to mutate state outside of the function.
+ You MUST return a value from the function.
+ NEVER attach UI to the DOM. If you need a root DOM element, the caller MUST provide it.
+ NEVER assume that a library is being used, e.g. React, Lodash, etc.
+ NEVER import any libraries (e.g. lodash, moment, React etc).
+ NEVER use TypeScript. 
+ NEVER use NodeJS APIs. 
+ NEVER use Deno specific APIs.
+ Return a function using traditional function format, i.e 'function test() { return 1; }'. DO NOT use arrow functions.
+ NEVER assign the function to a variable.
+ NEVER return anything other than the function, e.g, no examples, no console.log`;
    })

    return new Promise((resolve, reject) => {
      effect(() => {
        const functionScript = genFunc.value;
        try {
          const js = parseJS(functionScript);

          if (js) {
            const func = eval(`(() => { "use strict"; return ${js}; })()`);
            resolve(func);
          }
        }
        catch (e) {
          reject(e);
        }
      });
    });
  }

  const sum = await f`sum two numbers`;
  const isOdd = await f`is a number odd`;
  const fetchNews = await f`fetch data from https://api.spaceflightnewsapi.net/v4/articles/ and return JSON`;
  const addList = await f`Create a UI that allows you to add items to a list and remove items from a list. The developer can provide a list of items. The list should be displayed on the screen attached to a DOM element that I will specify. The list should be displayed in a vertical list. The list should be displayed in the order that the items were added. The list should have a remove button next to each item that when clicked will remove the item from the list. The list should have an input field and a button that when clicked will add the item to the list. The input field should be cleared after the item is added to the list.`;

  console.log("Sum code", sum)

  console.log("Sum 1 + 23", sum(1, 23))

  console.log("isOdd code", isOdd)
  console.log(1, "isOdd", isOdd(1))
  console.log(2, "isOdd", isOdd(2))

  console.log("fetchNews code", fetchNews)
  console.log("fetchNews data", await fetchNews())

  console.log("addList code", addList);
  await addList([2, 4, 6, 8, 10], document.body);

</script>